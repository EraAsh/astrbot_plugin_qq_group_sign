# QQ防撤回插件 (AstrBot Plugin)

## 功能介绍

这是一个QQ防撤回插件，能够监听QQ群和个人消息的撤回事件，并自动将撤回的消息内容转发给指定的管理员或管理群。

### 主要功能

- 🚫 **消息撤回监听**: 实时监听QQ群和私聊消息的撤回事件
- 📝 **智能缓存**: 自动缓存最近的聊天消息，确保撤回时能获取完整内容
- 🤖 **AI过滤**: 可选的AI智能过滤功能，只转发重要消息
- 📧 **多渠道通知**: 支持同时通知多个管理员QQ和管理群
- ⚙️ **灵活配置**: 丰富的配置选项，满足不同需求
- 🎨 **自定义格式**: 支持自定义通知消息格式

## 安装方法

1. 将插件文件夹 `astrbot_plugin_anti_revoke` 放入 AstrBot 的 `data/plugins/` 目录下
2. 在 AstrBot WebUI 的插件管理页面启用本插件
3. 在插件配置页面设置相关参数

## 配置说明

### 基础配置

- **管理员QQ号**: 接收撤回消息通知的管理员QQ号，多个QQ号用逗号分隔
- **管理群号**: 接收撤回消息通知的管理群号，多个群号用逗号分隔
- **启用群聊防撤回**: 是否监听群聊消息撤回
- **启用私聊防撤回**: 是否监听私聊消息撤回

### 高级配置

- **通知格式**: 自定义撤回消息的通知格式，支持以下变量：
  - `{sender_name}`: 发送者昵称
  - `{sender_id}`: 发送者QQ号
  - `{group_name}`: 群聊名称
  - `{group_id}`: 群聊号码
  - `{message_content}`: 撤回的消息内容
  - `{message_time}`: 消息发送时间

- **启用AI过滤**: 是否使用AI智能过滤重要消息
- **AI过滤提示词**: 自定义AI判断消息重要性的提示词

### 默认通知格式

```
🚫 消息撤回提醒

发送者：{sender_name}({sender_id})
群聊：{group_name}({group_id})
时间：{message_time}

撤回内容：
{message_content}
```

## 使用说明

### 1. 基础使用

#### 步骤1：安装插件
1. 将插件文件夹 `astrbot_plugin_anti_revoke` 放入 AstrBot 的 `data/plugins/` 目录下
2. 重启 AstrBot 或在 WebUI 中重载插件

#### 步骤2：基础配置
1. 打开 AstrBot WebUI
2. 进入"插件管理"页面
3. 找到"QQ防撤回插件"并点击"管理"
4. 在配置页面设置以下必需参数：
   - **管理员QQ号**: 设置接收通知的管理员QQ号（如：123456789）
   - **管理群号**: 设置接收通知的管理群号（如：987654321）
   - **启用群聊防撤回**: 开启群聊监听
   - **启用私聊防撤回**: 开启私聊监听

#### 步骤3：测试功能
1. 在配置完成后，插件会自动开始工作
2. 让朋友在群聊或私聊中发送消息然后撤回
3. 管理员QQ号或管理群号会收到撤回通知

### 2. AI过滤功能

#### 启用AI过滤
1. 在插件配置中找到"启用AI过滤"选项
2. 将其设置为 `true`
3. 确保 AstrBot 已配置可用的大语言模型

#### 自定义AI过滤提示词
默认提示词：
```
请判断以下消息是否包含重要信息，如：重要通知、任务安排、联系方式、链接分享、文件分享等。如果包含重要信息，请回复"重要"，否则回复"不重要"。
```

自定义提示词示例：
```
请判断以下消息是否为工作相关的重要信息，包括但不限于：会议安排、工作任务、重要通知、客户信息等。如果是工作相关信息，请回复"重要"，否则回复"不重要"。
```

### 3. 命令使用

#### 查看插件状态
- `/antirevoke` 或 `/防撤回` 或 `/ar`: 查看插件当前状态和使用说明

#### 命令输出示例：
```
📊 QQ防撤回插件状态

✅ 插件运行状态：正常
🔧 群聊防撤回：已启用
💬 私聊防撤回：已启用
🤖 AI过滤功能：已启用
📈 缓存消息数：156条
👥 管理员QQ：123456789
👥 管理群：987654321

使用说明：本插件会自动监听QQ消息撤回事件，并将撤回的消息转发给管理员。
```

### 4. 高级使用场景

#### 场景1：多管理员通知
配置示例：
```
管理员QQ号: 123456789,987654321,555666777
管理群号: 111222333,444555666
```
这样撤回消息会同时通知3个管理员QQ和2个管理群。

#### 场景2：自定义通知格式
自定义格式示例：
```
⚠️ 【防撤回提醒】
👤 发送者：{sender_name}
🆔 QQ号：{sender_id}
🏠 群聊：{group_name}
📅 时间：{message_time}
📝 内容：{message_content}
```

#### 场景3：仅监听特定类型消息
如果只想监听群聊消息：
- 启用群聊防撤回：`true`
- 启用私聊防撤回：`false`

如果只想监听私聊消息：
- 启用群聊防撤回：`false`
- 启用私聊防撤回：`true`

### 5. 故障排除

#### 常见问题1：收不到撤回通知
**可能原因：**
- 管理员QQ号或管理群号未正确配置
- 相应的监听功能未启用
- 消息缓存已过期

**解决方法：**
1. 检查配置是否正确
2. 确认监听开关已开启
3. 测试时确保消息在撤回前已被缓存（等待几秒再撤回）

#### 常见问题2：AI过滤功能不工作
**可能原因：**
- AI过滤功能未启用
- AstrBot未配置大语言模型
- 网络连接问题

**解决方法：**
1. 确认AI过滤开关已开启
2. 检查AstrBot的大语言模型配置
3. 测试网络连接

#### 常见问题3：内存占用过高
**可能原因：**
- 消息缓存数量过多
- 缓存过期时间过长

**解决方法：**
1. 调整缓存消息数量（建议500-1000条）
2. 调整缓存过期时间（建议30-60分钟）
3. 重启插件清理缓存

## 技术特点

### 消息缓存机制

- 插件会缓存最近1000条消息（可配置）
- 缓存消息1小时后自动过期
- 撤回消息从缓存中移除，避免重复通知

### 性能优化

- 自动清理过期缓存，避免内存占用过高
- 异步处理消息，不影响主程序运行
- 完善的错误处理机制，确保插件稳定运行

### 兼容性

- 支持aiocqhttp协议端
- 支持QQ官方接口
- 兼容各种QQ机器人框架

## 注意事项

1. 插件需要配置管理员QQ号或管理群号才能正常工作
2. AI过滤功能需要配置可用的大语言模型
3. 消息缓存会占用一定的内存资源
4. 请确保遵守相关法律法规和平台规则

## 更新日志

### v1.0.0
- 初始版本发布
- 支持QQ群和私聊消息撤回监听
- 支持AI智能过滤功能
- 支持多管理员通知
- 支持自定义通知格式

## 问题反馈

如果遇到问题或有改进建议，请通过以下方式反馈：

- GitHub Issues: [提交问题](https://github.com/AstrBotDevs/astrbot_plugin_anti_revoke/issues)
- QQ群: 975206796

## 许可证

本插件采用 MIT 许可证，详见 [LICENSE](LICENSE) 文件。
